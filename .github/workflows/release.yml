name: Create Maven Central Index Release

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name'
        required: false
        default: ''

jobs:
  release:
    runs-on: oracle-vm-16cpu-64gb-x86-64
    timeout-minutes: 720

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: 8
        distribution: 'temurin'
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Set release variables
      run: |
        BUILD_DATE=$(date +%Y-%m-%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        if [ -n "${{ github.event.inputs.release_name }}" ]; then
          RELEASE_NAME="${{ github.event.inputs.release_name }}"
        else
          RELEASE_NAME="Maven Central Index $BUILD_DATE"
        fi
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        echo "TAG_NAME=v$BUILD_DATE" >> $GITHUB_ENV
        
    - name: Build Parent POM
      run: mvn -B -N install -f pom.xml
    - name: Build Nexus Indexer
      run: mvn -B install -f indexer/pom.xml
    - name: Create Nexus Index with date version
      run: mvn -f data-text/pom.xml clean compile package -DskipTests

    - name: Zip files
      run: |
        DATE=$(date +'%Y%m%d%H%M%S')
        ZIP="maven-index-data-v${DATE}.zip"
        zip -j "$ZIP" data-text/target/central.archive-metadata.txt data-text/target/central.archive-metadata.idx
        echo "ZIP_FILE=$ZIP" >> $GITHUB_ENV
      
    - name: Verify generated files
      run: |
        echo "=== Generated files ==="
        find data-text/target -name "*.zip" -type f
        
        ZIP_FILE=$(find data-text/target -name "maven-index-data-*.zip" | head -1)
        if [ -z "$ZIP_FILE" ]; then
          echo "❌ No ZIP file found!"
          exit 1
        fi
        
        echo "✅ Found ZIP file: $ZIP_FILE"
        echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
        
        # Get file size for release notes
        FILE_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
        echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
        
    - name: Generate release notes
      run: |
        cat > release-notes.md << EOF
        # Maven Central Repository Index - $BUILD_DATE
        
        This release contains the complete, corrected Maven Central repository index as text files.
        
        ## Contents
        - **Maven Central**: Complete artifact metadata from https://repo1.maven.org/maven2/
        
        ## File Format
        Each line in the text files contains:
        \`\`\`
        <sha1-hash> <groupId>:<artifactId>:<packaging>:<classifier>:<version>
        \`\`\`
        
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: ${{ env.RELEASE_NAME }}
        body_path: release-notes.md
        files: ${{ env.ZIP_FILE }}
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up
      if: always()
      run: |
        rm -f release-notes.md
